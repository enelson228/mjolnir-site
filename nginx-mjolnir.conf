# MJOLNIR site (nellysupreme.cloud)
# Note: tailscale is using :443 on tailscale0, so nginx binds only to the public IP.

server {
  listen 76.13.102.161:443 ssl;

  server_name nellysupreme.cloud www.nellysupreme.cloud;

  root /var/www/mjolnir;
  index index.html;

  ssl_certificate /etc/letsencrypt/live/nellysupreme.cloud/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/nellysupreme.cloud/privkey.pem;
  include /etc/letsencrypt/options-ssl-nginx.conf;
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

  # Basic hardening headers (safe defaults for static site)
  add_header X-Content-Type-Options nosniff always;
  add_header X-Frame-Options SAMEORIGIN always;
  add_header Content-Security-Policy "frame-ancestors 'self'" always;
  add_header Referrer-Policy no-referrer always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

  # MJOLNIR (main site)
  location / {
    try_files $uri $uri/ =404;
  }

  # Ensure correct manifest content-type
  location = /site.webmanifest {
    default_type application/manifest+json;
    try_files $uri =404;
  }

  # Favicons: donâ€™t cache aggressively (browsers are stubborn)
  location = /assets/favicon.ico {
    add_header Cache-Control "no-cache";
    try_files $uri =404;
  }

  # NelsonWeb app (static) under /nelsonweb/
  location ^~ /nelsonweb/ {
    alias /var/www/nelsonweb/;
    index index.html;
    try_files $uri $uri/ =404;
  }

  # Drops: public, no directory listing, no-store
  location ^~ /drops/ {
    add_header X-Content-Type-Options nosniff always;
    add_header Cache-Control "no-store" always;
    try_files $uri =404;
  }

  # Inbox: password-protected (Option B uploads via SFTP/SCP)
  location = /inbox {
    return 301 /inbox/;
  }

  location ^~ /inbox/ {
    auth_basic "MJOLNIR Uplink Cache";
    auth_basic_user_file /etc/nginx/.htpasswd-mjolnir;

    index index.html;

    add_header X-Content-Type-Options nosniff always;
    add_header Cache-Control "no-store" always;

    try_files $uri $uri/ =404;
  }

  # Cache static assets (except favicon above)
  location ~* \.(css|js|png|jpg|jpeg|gif|webp|svg|ico)$ {
    expires 7d;
    add_header Cache-Control "public, max-age=604800, immutable";
    try_files $uri =404;
  }
}

server {
  listen 76.13.102.161:80;

  server_name nellysupreme.cloud www.nellysupreme.cloud;
  return 301 https://$host$request_uri;
}
